<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css">
    <link rel="stylesheet" href="./style.css">
    <title>Plandars</title>

    <!-- vue -->
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8.1/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>

<body>

    <div id="app">

        <div class="wrapper" style='flex-direction: row;'>
            <div class="left_wrap">
                <!-- 헤더 -->
                <div class="calendar_header">
                    <i @click="moveDate('prev', '')" class="fas fa-angle-left" style="margin-right: 10px;"></i>
                    <span>{{ this.showYear }}.{{ this.showMonth }}</span>
                    <i @click="moveDate('next', '')" class="fas fa-angle-right" style="margin-left: 10px;"></i>
                    <i style="float: right; margin-top: 0.25em" class="fas fa-cogs"></i>
                </div>

                <table>
                    <!-- 요일 -->
                    <tr style="height: 30px;">
                        <td v-for="rows in weekList" class="calendar_cell">{{ rows }}</td>
                    </tr>

                    <!-- 일자 -->
                    <tr v-for="rows in calendarGrid">
                        <td v-for="(item, index) in rows" class="calendar_cell" v-if="item != null"
                            @click="selectDay(item.year, item.month, item.day)" style="cursor: pointer; height: 100%;">
                            <div :class="{ calendar_opaque: item.type!='now'}">
                                <p :class="{ calendar_holiday: index==0 || item.isHoliday }">{{ item.day }}</p>
                                <span v-for="(s, index) in item.schedule"
                                    :class="{ schedule_label_full: s.labelType=='full' }"
                                    v-bind:style="{ backgroundColor: s.labelColor }" v-if="index < 3">
                                    {{ s.labelText }}
                                </span>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- PC 우측 상세내용 -->
            <div class="right_bar">
                <div class="calendar_header">
                    <span>Day {{ this.selectedDay }}</span>
                </div>
                <div>
                    <p style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;"># 월간일정<i class="fas fa-plus" style="margin-left: 10px;"></i></p>
                    <br><br><br>

                    <p style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;"># 오늘일정<i class="fas fa-plus" style="margin-left: 10px;"></i></p>
                    <span v-for="(s, index) in selectedItem.schedule"
                        :class="{ schedule_label_full: s.labelType=='full' }" v-bind:style="{ color: s.labelColor }">
                        {{ s.labelText }}
                    </span><br>
                    <br><br><br>

                    <p style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;"># 체크리스트<i class="fas fa-plus" style="margin-left: 10px;"></i></p>

                </div>
            </div>
        </div>
    </div>
</body>


<script>
    new Vue({
        el: '#app',
        data: {
            gridMaxCount: 7,
            dateList: [], // 이번달에 그릴 날짜 리스트
            calendarGrid: [], // dateList를 그리드 형식으로 그리기 위해 사용되는 리스트
            weekList: ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"],
            selectedYear: 0,
            selectedMonth: "",
            selectedDay: 0,
            showYear: 0,
            showMonth: "",
            selectedItem: {},
            allScheduleList: [], // 전체 일정 목록
        },
        methods: {
            getCalendar: function (yyyy, m) {
                console.log("getCalendar : " + yyyy + "-" + m);
                this.dateList = [];
                this.calendarGrid = [];
                this.allScheduleList = [];

                var firstDate = new Date(yyyy, m - 1, 1);
                let lastDate = new Date(yyyy, m, 0);

                // 당월 첫날의 요일 구하기 (일요일부터 시작)
                let firstDayOfWeek = firstDate.getDay();
                let prevDate = new Date(new Date(yyyy, m - 1, 1).setDate(new Date(yyyy, m - 1, 1).getDate() - 1));
                let prevYear = new Date(new Date(yyyy, m - 1, 1).setDate(new Date(yyyy, m - 1, 1).getDate() - 1)).getFullYear();
                let prevMonth = new Date(new Date(yyyy, m - 1, 1).setDate(new Date(yyyy, m - 1, 1).getDate() - 1)).getMonth() + 1;


                // 전월 데이터 채우기
                if (firstDayOfWeek != 0) { // 당월 1일이 일요일이 아니면 앞에 전월 데이터를 추가해야하기 때문
                    for (var i = 0; i < firstDayOfWeek; i++) {
                        this.dateList.unshift({
                            year: prevYear,
                            month: this.makeTwoString(prevMonth),
                            day: prevDate.getDate() - i,
                            type: "prev",
                            schedule: [],
                            isHoliday: false
                        });
                    }
                }

                // 당월 데이터 채우기
                for (var i = 1; i <= lastDate.getDate(); i++) {
                    this.dateList.push({
                        year: yyyy,
                        month: this.makeTwoString(m),
                        day: this.makeTwoString(i),
                        type: "now",
                        schedule: [],
                        isHoliday: false
                    });
                }

                // 당월 마지막날의 요일 구하기 (일요일부터 시작)
                let lastDayOfWeek = lastDate.getDay();
                let nextDate = new Date(new Date(yyyy, m, 0).setDate(new Date(yyyy, m, 0).getDate() + 1)).getDate();
                let nextYear = new Date(new Date(yyyy, m, 0).setDate(new Date(yyyy, m, 0).getDate() + 1)).getFullYear();
                let nextMonth = new Date(new Date(yyyy, m, 0).setDate(new Date(yyyy, m, 0).getDate() + 1)).getMonth() + 1;

                // 다음월 데이터 채우기
                if (lastDayOfWeek != 6) { // 당월 마지막날짜가 토요일이 아니면 나머지 공간을 채워줘야하기 때문
                    for (var i = 0; i < 6 - lastDayOfWeek; i++) {
                        this.dateList.push({
                            year: nextYear,
                            month: this.makeTwoString(nextMonth),
                            day: "0" + (i + 1),
                            type: "next",
                            schedule: [],
                            isHoliday: false
                        });
                    }
                }

                this.getAllSchedules();
            },
            getAllSchedules: function () {

                // 휴일 리스트 조회 후 스케쥴에 저장
                var self = this;
                axios.get('./holiday.csv')
                    .then(function (result) {
                        var list = result.data.split(/\r?\n|\r/);
                        for (var i = 1; i < list.length; i++) {
                            var listData = list[i].split(',');
                            self.allScheduleList.push({
                                startDate: listData[1],
                                endDate: listData[2],
                                isHoliday: true,
                                labelText: listData[4],
                                labelColor: "red",
                                labelType: "full",
                                labelCategory: listData[0]
                            });
                        }


                        //# 음력/양력 처리할것
                        for (var i = 0; i < self.allScheduleList.length; i++) {
                            for (var j = 0; j < self.dateList.length; j++) {
                                var schedule = self.allScheduleList[i];
                                let date = String(self.dateList[j].month) + String(self.dateList[j].day);
                                if (schedule.startDate.indexOf('0000') >= 0) {
                                    if (date >= (String(schedule.startDate.split("-")[1]) + String(schedule.startDate.split("-")[2]))
                                        && date <= (String(schedule.endDate.split("-")[1]) + String(schedule.endDate.split("-")[2]))) {
                                        self.dateList[j].isHoliday = schedule.isHoliday;
                                        self.dateList[j].schedule.push({
                                            labelText: schedule.labelText,
                                            labelColor: schedule.labelColor,
                                            labelType: schedule.labelType,
                                            labelCategory: schedule.labelCategory
                                        })
                                    }
                                }
                            }
                        }

                    }).catch(function (e) {
                        console.error(e);
                        console.log("휴일 정보 조회 오류");
                    })

                this.drawCalendar();
            },
            drawCalendar: function () {
                var remain = this.dateList.length % this.gridMaxCount;
                var lines = this.dateList.length / this.gridMaxCount;
                if (remain != 0) {
                    lines = lines + 1;
                }
                lines = Math.floor(lines);

                for (var i = 0; i < lines; i++) {
                    var subList = this.dateList.slice((i * this.gridMaxCount), (i * this.gridMaxCount) + this.gridMaxCount);
                    if (subList.length < this.gridMaxCount) {
                        var loopCount = this.gridMaxCount - subList.length;
                        for (var j = 0; j < loopCount; j++) {
                            subList.push(null);
                        }
                    }
                    this.calendarGrid.push(subList);
                }
            },
            makeTwoString: function (num) { // 한자리수 숫자 1을 두자리수 문자열 "01"로 변환
                var temp = num;
                if (temp < 10) {
                    temp = "0" + num;
                }
                return temp;
            },
            selectDay: function (year, month, day) {
                this.showYear = year;
                this.showMonth = month;
                this.selectedDay = day;

                for (var i = 0; i < this.dateList.length; i++) {
                    if (this.dateList[i].year == year && this.dateList[i].month == month && this.dateList[i].day == day) {
                        this.selectedItem = this.dateList[i];
                    }
                }
                if (this.selectedItem.type != "now") {
                    this.getCalendar(this.showYear, parseInt(this.showMonth));
                }
            },
            moveDate: function (year, month) {

                if (year == 'prev') {
                    var prevDate = new Date(this.showYear, this.showMonth - 1, this.selectedDay);
                    var monthOfYear = prevDate.getMonth();
                    prevDate.setMonth(monthOfYear - 1);
                    this.showYear = prevDate.getFullYear();
                    this.showMonth = this.makeTwoString(Number(prevDate.getMonth() + 1));
                    this.getCalendar(prevDate.getFullYear(), Number(prevDate.getMonth() + 1));
                } else if (year == 'next') {
                    var nextDate = new Date(this.showYear, this.showMonth - 1, this.selectedDay);
                    var monthOfYear = nextDate.getMonth();
                    nextDate.setMonth(monthOfYear + 1);
                    this.showYear = nextDate.getFullYear();
                    this.showMonth = this.makeTwoString(Number(nextDate.getMonth() + 1));
                    this.getCalendar(nextDate.getFullYear(), Number(nextDate.getMonth() + 1))
                } else {
                    this.getCalendar(year, month);
                }
            }
        },
        created: function () {

            let now = new Date();
            console.log(now);
            this.selectedYear = now.getFullYear();
            this.selectedMonth = this.makeTwoString(now.getMonth()+1);
            this.selectedDay = now.getDate();
            this.showYear = now.getFullYear();
            this.showMonth = this.makeTwoString(now.getMonth()+1);


            this.getCalendar(this.showYear, parseInt(this.showMonth));
            var self = this;

            setTimeout(function () {
                self.selectDay(self.showYear, self.showMonth, self.selectedDay);
            }, 500);
        }
    });



    // Pinch Zoom 끄기
    document.documentElement.addEventListener('touchstart', function (event) { if (event.touches.length > 1) { event.preventDefault(); } }, false);

    // Double tab Zoom 끄기
    var lastTouchEnd = 0; document.documentElement.addEventListener('touchend', function (event) { var now = (new Date()).getTime(); if (now - lastTouchEnd <= 300) { event.preventDefault(); } lastTouchEnd = now; }, false);
</script>

</html>